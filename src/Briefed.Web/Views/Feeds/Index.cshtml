@model IEnumerable<Briefed.Web.Models.FeedWithStatsViewModel>
@{
    ViewData["Title"] = "My Feeds";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üì∞ My RSS Feeds</h2>
    <div class="d-flex gap-2">
        <form asp-action="RefreshAllArticles" method="post" class="d-inline" onsubmit="return confirm('This will refresh all articles from all feeds. Continue?');">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-outline-success">üîÑ Refresh All Articles</button>
        </form>
        <a asp-action="Import" class="btn btn-outline-primary">üì• Import OPML</a>
        <a asp-action="Browse" class="btn btn-outline-info">üîç Browse Feeds</a>
        <a asp-action="Create" class="btn btn-primary">+ Add Feed</a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <h5>Welcome to Briefed!</h5>
        <p>You haven't subscribed to any feeds yet. Get started by adding your first RSS feed.</p>
        <a asp-action="Create" class="btn btn-primary">Add Your First Feed</a>
    </div>
}
else
{
    <div class="mb-3">
        <input type="text" id="feedSearch" class="form-control" placeholder="üîç Search feeds..." onkeyup="filterFeeds()">
    </div>
    <div class="row" id="feedsContainer">
        @foreach (var feedStat in Model)
        {
            var feed = feedStat.Feed;
            <div class="col-md-6 col-lg-4 mb-2 feed-card" data-feed-title="@feed.Title.ToLower()">
                <div class="card h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start mb-2">
                            @if (!string.IsNullOrEmpty(feed.FaviconUrl))
                            {
                                <img src="@feed.FaviconUrl" alt="@feed.Title" class="me-2 mt-1" style="width: 16px; height: 16px;" onerror="this.src='/favicon.ico'">
                            }
                            else
                            {
                                <img src="/favicon.ico" alt="@feed.Title" class="me-2 mt-1" style="width: 16px; height: 16px;">
                            }
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    @feed.Title
                                    @if (feedStat.UnreadArticles > 0)
                                    {
                                        <span class="badge bg-primary rounded-pill">@feedStat.UnreadArticles</span>
                                    }
                                </h6>
                                <small class="text-muted">
                                    <strong>@feedStat.TotalArticles</strong> articles
                                    @if (feed.LastFetchedAt.HasValue)
                                    {
                                        <span class="ms-2">‚Ä¢ @feed.LastFetchedAt.Value.ToLocalTime().ToString("MMM dd, h:mm tt")</span>
                                    }
                                </small>
                            </div>
                        </div>
                        <div class="d-flex gap-1 flex-wrap">
                            <form asp-action="MarkAllAsRead" asp-route-id="@feed.Id" method="post" class="d-inline"
                                  onsubmit="return confirm('Mark all articles from this feed as read?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-success" @(feedStat.UnreadArticles == 0 ? "disabled" : "")>
                                    ‚úì
                                </button>
                            </form>
                            <form asp-action="Unsubscribe" asp-route-id="@feed.Id" method="post" class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to unsubscribe from this feed?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger">√ó</button>
                            </form>
                            <a href="@feed.Url" target="_blank" class="btn btn-sm btn-outline-secondary">üîó</a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
@section Scripts {
    <script>
        function filterFeeds() {
            const searchInput = document.getElementById('feedSearch');
            const filter = searchInput.value.toLowerCase();
            const feedCards = document.querySelectorAll('.feed-card');
            let visibleCount = 0;
            
            feedCards.forEach(card => {
                const feedTitle = card.getAttribute('data-feed-title');
                if (feedTitle.includes(filter)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show message if no feeds match
            let noResultsMsg = document.getElementById('noResultsMessage');
            if (visibleCount === 0 && filter !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'col-12 alert alert-info';
                    noResultsMsg.textContent = 'No feeds found matching your search.';
                    document.getElementById('feedsContainer').appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
    </script>
}