@model Briefed.Web.Models.ArticleReadViewModel
@{
    ViewData["Title"] = Model.Article.Title;
}

<div class="row">
    <div class="col-lg-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Articles</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Article.Feed.Title</li>
            </ol>
        </nav>

        <h1 class="mb-4 fw-bold" style="font-size: 2.5rem; line-height: 1.2;">@Model.Article.Title</h1>
        
        <div class="mb-4 pb-3 border-bottom">
            <p class="text-muted mb-0" style="font-size: 0.95rem;">
                <strong>@Model.Article.Feed.Title</strong>
                <span class="mx-2">‚Ä¢</span>
                <time>@Model.Article.PublishedAt.ToLocalTime().ToString("MMMM dd, yyyy h:mm tt")</time>
                @if (!string.IsNullOrEmpty(Model.Article.Author))
                {
                    <span class="mx-2">‚Ä¢</span>
                    <span>By @Model.Article.Author</span>
                }
            </p>
        </div>

        <div class="mb-4">
            @if (!Model.IsSaved)
            {
                <form asp-action="Save" asp-route-id="@Model.Article.Id" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-primary">üíæ Save for Later</button>
                </form>
            }
            else
            {
                <span class="badge bg-success">‚úì Saved</span>
            }
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="summariseBtn" data-article-id="@Model.Article.Id" data-summary-type="comprehensive">
                    ‚ú® Summarise with AI
                </button>
                <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item summary-type-option" href="#" data-type="comprehensive">üìù Comprehensive</a></li>
                    <li><a class="dropdown-item summary-type-option" href="#" data-type="concise">‚ö° Concise</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-warning" id="factCheckBtn" data-article-id="@Model.Article.Id">
                üîç Fact Check
            </button>
            <a href="@Model.Article.Url" target="_blank" class="btn btn-outline-secondary">Open Original</a>
        </div>

        @if (!string.IsNullOrEmpty(Model.Article.ImageUrl))
        {
            <img src="@Model.Article.ImageUrl" alt="Article image" class="img-fluid mb-4 rounded" />
        }

        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">
                <div class="article-content">
                    @Html.Raw(System.Net.WebUtility.HtmlDecode(Model.Content))
                </div>
            </div>
        </div>

        <div class="mt-4">
            <a href="@Model.Article.Url" target="_blank" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-up-right"></i> Read Original Article
            </a>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="position-sticky" style="top: 20px;">
            <div id="factCheckPanel" class="card mb-3" style="display: none;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üîç Fact Check Results</h5>
                </div>
                <div class="card-body">
                    <div id="factCheckContent"></div>
                </div>
            </div>
            
            <div id="summaryPanel" class="card" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ü§ñ AI Summary</h5>
                </div>
                <div class="card-body">
                    <p id="summaryContent" class="card-text"></p>
                    <small class="text-muted">Generated by Ollama</small>
                </div>
            </div>
            
            @if (Model.Article.Summary != null)
            {
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ü§ñ AI Summary</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">@Model.Article.Summary.Content</p>
                        <small class="text-muted">Generated by @Model.Article.Summary.Model</small>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Handle summary type selection
        document.querySelectorAll('.summary-type-option').forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const summaryType = this.dataset.type;
                const btn = document.getElementById('summariseBtn');
                btn.dataset.summaryType = summaryType;
                btn.innerHTML = summaryType === 'concise' ? '‚ö° Summarise (Concise)' : 'üìù Summarise (Comprehensive)';
            });
        });

        document.getElementById('summariseBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            const articleId = button.dataset.articleId;
            const summaryType = button.dataset.summaryType || 'comprehensive';
            const summaryPanel = document.getElementById('summaryPanel');
            const summaryContent = document.getElementById('summaryContent');
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating summary...';
            
            try {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch('@Url.Action("Summarise")?id=' + articleId + '&summaryType=' + summaryType, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    summaryContent.textContent = result.summary;
                    summaryPanel.style.display = 'block';
                    button.innerHTML = '‚úì Summary Generated';
                    button.dataset.summaryType = 'comprehensive';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate summary'));
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                alert('Error generating summary: ' + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        document.getElementById('factCheckBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            const factCheckPanel = document.getElementById('factCheckPanel');
            const factCheckContent = document.getElementById('factCheckContent');
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Fact checking...';
            
            try {
                // Get the article content
                const articleContent = document.querySelector('.article-content').innerText;
                
                const response = await fetch('/FactCheck/CheckArticle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ articleText: articleContent })
                });
                
                const results = await response.json();
                
                if (results && results.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    results.forEach((result, index) => {
                        const ratingClass = result.textualRating?.toLowerCase().includes('false') ? 'danger' : 
                                          result.textualRating?.toLowerCase().includes('true') ? 'success' : 'warning';
                        
                        const confidenceClass = result.confidence === 'High' ? 'success' : 
                                              result.confidence === 'Medium' ? 'warning' : 'secondary';
                        
                        html += `
                            <div class="list-group-item px-0">
                                <h6 class="mb-2"><strong>Claim ${index + 1}:</strong></h6>
                                <p class="mb-2 small">${result.claim || 'N/A'}</p>
                                
                                <div class="mb-2">
                                    ${result.textualRating ? `<span class="badge bg-${ratingClass}">${result.textualRating}</span>` : ''}
                                    ${result.confidence ? `<span class="badge bg-${confidenceClass} ms-1">${result.confidence} Confidence</span>` : ''}
                                    ${result.source ? `<span class="badge bg-info ms-1">${result.source}</span>` : ''}
                                </div>
                                
                                ${result.reasoning ? `<p class="mb-2 small"><strong>Analysis:</strong> ${result.reasoning}</p>` : ''}
                                ${result.publisher ? `<p class="mb-1 small"><strong>Source:</strong> ${result.publisher}</p>` : ''}
                                ${result.claimReview && !result.reasoning ? `<p class="mb-1 small text-muted">${result.claimReview}</p>` : ''}
                                ${result.url ? `<a href="${result.url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Read Full Review</a>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    factCheckContent.innerHTML = html;
                    factCheckPanel.style.display = 'block';
                    button.innerHTML = '‚úì Fact Checked';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-outline-warning');
                } else {
                    factCheckContent.innerHTML = '<p class="text-muted mb-0">No fact-checks found for claims in this article.</p>';
                    factCheckPanel.style.display = 'block';
                    button.innerHTML = '‚úì No Matches Found';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-outline-warning');
                }
            } catch (error) {
                alert('Error fact checking: ' + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    </script>
}
