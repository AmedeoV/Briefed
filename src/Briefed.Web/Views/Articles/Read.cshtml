@model Briefed.Web.Models.ArticleReadViewModel
@{
    ViewData["Title"] = Model.Article.Title;
}

<div class="row">
    <div class="col-lg-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Articles</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Article.Feed.Title</li>
            </ol>
        </nav>

        <h1 class="mb-4 fw-bold" style="font-size: 2.5rem; line-height: 1.2;">@Model.Article.Title</h1>
        
        <div class="mb-4 pb-3 border-bottom">
            <p class="text-muted mb-0" style="font-size: 0.95rem;">
                <strong>@Model.Article.Feed.Title</strong>
                <span class="mx-2">â€¢</span>
                <time>@Model.Article.PublishedAt.ToLocalTime().ToString("MMMM dd, yyyy h:mm tt")</time>
                @if (!string.IsNullOrEmpty(Model.Article.Author))
                {
                    <span class="mx-2">â€¢</span>
                    <span>By @Model.Article.Author</span>
                }
            </p>
        </div>

        <div class="mb-4">
            @if (!Model.IsSaved)
            {
                <form asp-action="Save" asp-route-id="@Model.Article.Id" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-primary">ðŸ’¾ Save for Later</button>
                </form>
            }
            else
            {
                <span class="badge bg-success">âœ“ Saved</span>
            }
            <button type="button" class="btn btn-success" id="summarizeBtn" data-article-id="@Model.Article.Id">
                âœ¨ Summarize with AI
            </button>
            <a href="@Model.Article.Url" target="_blank" class="btn btn-outline-secondary">Open Original</a>
        </div>

        @if (!string.IsNullOrEmpty(Model.Article.ImageUrl))
        {
            <img src="@Model.Article.ImageUrl" alt="Article image" class="img-fluid mb-4 rounded" />
        }

        <div class="card border-0 shadow-sm">
            <div class="card-body p-4 p-md-5">
                <div class="article-content">
                    @Html.Raw(System.Net.WebUtility.HtmlDecode(Model.Content))
                </div>
            </div>
        </div>

        <div class="mt-4">
            <a href="@Model.Article.Url" target="_blank" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-up-right"></i> Read Original Article
            </a>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="position-sticky" style="top: 20px;">
            <div id="summaryPanel" class="card" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ðŸ¤– AI Summary</h5>
                </div>
                <div class="card-body">
                    <p id="summaryContent" class="card-text"></p>
                    <small class="text-muted">Generated by Ollama</small>
                </div>
            </div>
            
            @if (Model.Article.Summary != null)
            {
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ðŸ¤– AI Summary</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">@Model.Article.Summary.Content</p>
                        <small class="text-muted">Generated by @Model.Article.Summary.Model</small>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('summarizeBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            const articleId = button.dataset.articleId;
            const summaryPanel = document.getElementById('summaryPanel');
            const summaryContent = document.getElementById('summaryContent');
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating summary...';
            
            try {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                
                const response = await fetch('@Url.Action("Summarize")?id=' + articleId, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    summaryContent.textContent = result.summary;
                    summaryPanel.style.display = 'block';
                    button.innerHTML = 'âœ“ Summary Generated';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-success');
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate summary'));
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                alert('Error generating summary: ' + error.message);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    </script>
}
