@using Briefed.Web.Controllers
@model AdminDashboardViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üõ°Ô∏è Admin Dashboard</h2>
        <a asp-controller="Articles" asp-action="Index" class="btn btn-secondary">Back to Articles</a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">üë• Total Users</h5>
                    <h2 class="mb-0">@Model.TotalUsers</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">üì° Total Feeds</h5>
                    <h2 class="mb-0">@Model.TotalFeeds</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">üì∞ Total Articles</h5>
                    <h2 class="mb-0">@Model.TotalArticles</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">‚ú® Total Summaries</h5>
                    <h2 class="mb-0">@Model.TotalSummaries</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üîß System Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <form asp-action="TriggerFeedUpdate" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-primary w-100">
                            üîÑ Trigger Feed Update
                        </button>
                    </form>
                    <small class="text-muted">Manually trigger an immediate feed update for all feeds</small>
                </div>
                <div class="col-md-4 mb-3">
                    <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#cleanupModal">
                        üóëÔ∏è Cleanup Old Articles
                    </button>
                    <small class="text-muted">Remove articles older than specified days</small>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="/hangfire" class="btn btn-info w-100" target="_blank">
                        üìä Hangfire Dashboard
                    </a>
                    <small class="text-muted">View background jobs and schedules</small>
                </div>
            </div>
        </div>
    </div>

    <!-- GNews API Usage -->
    @if (Model.CachedTrendingArticles.Any())
    {
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üåç GNews API Usage (100 calls/day limit)</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>üìä Cache Strategy:</strong> Trending articles are cached for 24 hours to minimize API usage. 
                    Each country/category combination uses 1 API call. Currently <strong>@Model.CachedTrendingArticles.Count cached combinations</strong>.
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Country/Category</th>
                                <th>Last Fetched</th>
                                <th>Expires In</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.CachedTrendingArticles.Take(10))
                            {
                                var timeAgo = DateTime.UtcNow - item.Value.LastFetch;
                                var timeAgoText = timeAgo.TotalHours >= 1 
                                    ? $"{(int)timeAgo.TotalHours}h {timeAgo.Minutes}m ago" 
                                    : $"{(int)timeAgo.TotalMinutes}m ago";
                                var expiryText = item.Value.TimeUntilExpiry.TotalHours >= 1
                                    ? $"{(int)item.Value.TimeUntilExpiry.TotalHours}h {item.Value.TimeUntilExpiry.Minutes}m"
                                    : $"{(int)item.Value.TimeUntilExpiry.TotalMinutes}m";
                                <tr>
                                    <td><strong>@item.Key</strong></td>
                                    <td>@timeAgoText</td>
                                    <td>@expiryText</td>
                                    <td>
                                        <a href="@Url.Action("Trending", "Articles", new { country = item.Value.Country.ToLower() == "worldwide" ? "" : item.Value.Country.ToLower(), category = item.Value.Category, refresh = true })" 
                                           class="btn btn-xs btn-outline-primary">
                                            üîÑ Refresh
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (Model.CachedTrendingArticles.Count > 10)
                {
                    <small class="text-muted">Showing 10 of @Model.CachedTrendingArticles.Count cached combinations</small>
                }
            </div>
        </div>
    }

    <div class="row">
        <!-- Recent Users -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üë• Recent Users</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Feeds</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model.RecentUsers)
                                {
                                    <tr>
                                        <td>@user.Email</td>
                                        <td>@user.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                        <td>@user.FeedCount</td>
                                        <td>
                                            <form asp-action="DeleteUser" asp-route-id="@user.Id" method="post" class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this user?');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Feeds -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì° Top Feeds</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Subscribers</th>
                                    <th>Articles</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var feed in Model.TopFeeds)
                                {
                                    <tr>
                                        <td>
                                            <a href="@feed.Url" target="_blank" title="@feed.Url">
                                                @(feed.Title.Length > 30 ? feed.Title.Substring(0, 30) + "..." : feed.Title)
                                            </a>
                                        </td>
                                        <td>@feed.SubscriberCount</td>
                                        <td>@feed.ArticleCount</td>
                                        <td>
                                            <form asp-action="DeleteFeed" asp-route-id="@feed.Id" method="post" class="d-inline"
                                                  onsubmit="return confirm('Are you sure you want to delete this feed? This will remove it for all users.');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Dark theme table styling */
    [data-theme="dark"] .table {
        --bs-table-bg: transparent;
        --bs-table-color: #dee2e6;
        --bs-table-border-color: #495057;
        --bs-table-striped-bg: #2c3034;
        --bs-table-striped-color: #dee2e6;
        --bs-table-active-bg: #373b3e;
        --bs-table-active-color: #dee2e6;
        --bs-table-hover-bg: #323539;
        --bs-table-hover-color: #dee2e6;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .table > :not(caption) > * > * {
        background-color: transparent;
        border-bottom-color: #495057;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .table > thead {
        background-color: #2c3034;
    }
    
    [data-theme="dark"] .table-hover > tbody > tr:hover > * {
        --bs-table-accent-bg: #323539;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .modal-content {
        background-color: #212529;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .modal-header,
    [data-theme="dark"] .modal-footer {
        border-color: #495057;
    }
    
    [data-theme="dark"] .form-control {
        background-color: #2c3034;
        border-color: #495057;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .form-control:focus {
        background-color: #2c3034;
        border-color: #6c757d;
        color: #dee2e6;
    }
    
    [data-theme="dark"] .form-label,
    [data-theme="dark"] .text-muted {
        color: #adb5bd !important;
    }
</style>

<!-- Cleanup Modal -->
<div class="modal fade" id="cleanupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cleanup Old Articles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="CleanupOldArticles" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="daysOld" class="form-label">Delete articles older than (days):</label>
                        <input type="number" class="form-control" id="daysOld" name="daysOld" value="30" min="1" max="365">
                        <small class="text-muted">This action cannot be undone.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Cleanup Articles</button>
                </div>
            </form>
        </div>
    </div>
</div>
